<!doctype html>
<html>

<head>
	<meta charset="utf-8">
	<title>Generate</title>
	<meta name="viewport" content="width=device-width,initial-scale=1">

	<script type="module">
		import * as SudokuProcess from "./process.js";

		const generateButton = document.createElement('button');
		generateButton.style.top = '8px';
		generateButton.style.right = '8px';
		generateButton.style.position = 'absolute';
		generateButton.style.height = '32px';
		generateButton.appendChild(document.createTextNode("Generate"));

		const searchParams = new URLSearchParams(window.location.search);

		const body = document.createElement('pre');

		const setMessage = (message) => {
			body.innerText = message.join('\n');
		};

		const sentDisplay = document.createElement('span');
		sentDisplay.style.position = 'absolute';
		sentDisplay.style.top = '48px';
		sentDisplay.style.right = '8px';
		sentDisplay.style.fontFamily = 'Courier New';
		sentDisplay.style.visibility = 'hidden';
		sentDisplay.textContent = "Sent: 0";
		document.body.appendChild(sentDisplay);

		let strategyCounter = null;
		let workers = null;
		const toggleWorker = () => {
			if (workers) {
				for (const worker of workers) worker.terminate();
				workers = null;
				return;
			}
			workers = [];
			if (!strategyCounter) strategyCounter = new SudokuProcess.StrategyCounter();

			const coresString = searchParams.get("cores");
			const cores = (coresString === null) ? 1 : parseInt(coresString);
			for (let i = 0; i < cores; i++) workers[i] = new Worker("worker.js", { type: "module" });
		};

		const sendDataStack = [];
		let sendDataSending = false;
		let sendDataSent = 0;
		const maxSend = 100;
		const sendData = (currentData) => {
			if (currentData) sendDataStack.push(currentData);
			if (sendDataSending) return;
			if (sendDataStack.length === 0) return;
			sendDataSending = true;

			const url = './generate.php?version=2';
			const readyDataSend = [];
			for (const ready of sendDataStack) {
				let post = ready;
				if (!post.puzzleData) {
					const puzzleData = SudokuProcess.puzzleGridHex(ready.puzzleClues, ready.puzzleFilled);
					post = {
						id: ready.id,
						puzzleData: puzzleData,
						clueCount: ready.clueCount,

						solveType: ready.solveType,

						hiddenSimple: ready.hiddenSimple,
						omissionSimple: ready.omissionSimple,
						nakedSimple: ready.nakedSimple,

						nakedVisible: ready.nakedVisible,
						omissionVisible: ready.omissionVisible,

						naked2: ready.naked2,
						naked3: ready.naked3,
						naked4: ready.naked4,
						hidden1: ready.hidden1,
						hidden2: ready.hidden2,
						hidden3: ready.hidden3,
						hidden4: ready.hidden4,
						omissions: ready.omissions,
						uniqueRectangle: ready.uniqueRectangle,
						yWing: ready.yWing,
						xyzWing: ready.xyzWing,
						xWing: ready.xWing,
						swordfish: ready.swordfish,
						jellyfish: ready.jellyfish,
					};
				}

				readyDataSend.push(post);
				if (readyDataSend.length === maxSend) break;
			}
			sendDataStack.splice(0, readyDataSend.length);

			fetch(url, {
				cache: "no-store",
				method: "POST",
				body: JSON.stringify(readyDataSend),
			}).then(response => {
				response.text().then((string) => {
					const fields = string.split(":");
					if (fields.length !== 2) {
						if (workers) toggleWorker();
						return;
					}

					sendDataSent += readyDataSend.length;
					sentDisplay.textContent = "Sent: " + sendDataSent;

					sendDataSending = false;
					if (sendDataStack.length > 0) sendData();
				});
			});
		};

		const processGenerate = () => {
			sentDisplay.style.visibility = 'visible';

			for (const worker of workers) {
				const workerData = {};
				workerData.run = true;
				worker.onmessage = (e) => {
					const data = e.data;
					strategyCounter.addData(data);
					setMessage(strategyCounter.lines());
					sendData(data);
				};
				worker.postMessage(workerData);
			}
		};

		generateButton.addEventListener('click', () => {
			toggleWorker();
			if (workers) processGenerate();
		});

		document.body.appendChild(generateButton);

		document.body.appendChild(body);
	</script>

</head>

<body></body>

</html>